# 影响服务质量的因素

## 通常面对以下业务场景

- 大量无用业务逻辑
- sleep
- 循环里写查询
- 磁盘满了、影响到有磁盘写操作的接口
- 慢查询的SQL
- Redis 中存在大 key ，带宽打满不知是哪些接口影响与被影响
- 队列堆积却不知哪些接口影响
- 流量放大系数评估全靠经验和看代码
- .......

## 资源依赖

- 接口依赖（内部服务、外部服务）
	- 无法整体查看服务、接口、资源之间的依赖关系
	- 没有很好的外部服务监控机制、无法统计依赖的服务质量
- 数据资源依赖 （DB、 Redis、 Memcached、 队列）
	- 无法整体查看服务、接口、资源之间的依赖关系
	- 容量评估及扩容标准全靠经验
	- 出问题后仅能凭经验逐一排查、无法迅速定位到代码层面
	- 完全依赖 dba 帮忙排查
- 服务器资源依赖（负载、内存 、网络……）
	- 资源指标上升后、无法判断数值是常规上升还是资源异常
- ......

## 流量

- 流量来袭时、无法整体感知流量状况
	- 流量多大算大
	- 核心业务是否收到影响
	- 单一接口流量增加却未达到整体的告警线、导致无法感知
	- 可视化是否实时
- 无法直观统计流量分布、无法查看具体每个接口的流量情况
- 容量评估时、流量放大系数全靠人为判断、对服务整体的放大系数无感知
- ......

# 故障发现

- 一个高可用的业务系统除了技术架构支撑之外，监控系统作为事中决策支撑和事后决策止损是必不可少的一部分

- 工具
	- Prometheus
	- Zabbix
	- Nagios
	- Open-Falcon
	- Pageduty 等

## 监控体系汇总

### 监控体系分类

一般可分为

- 系统级别监控
- **业务监控**
- 网络监控
- 程序代码监控
- 日志监控
- 用户行为分析监控
- 其他种类监控等


#### 系统级别监控

主要跟操作系统相关的基本监控项

- 物理监控（对物理机或者容器的监控）：存活、内存、cpu、load、硬盘（速率、使用率）、网络
- 活性检测：进程 、端口
- 应用服务监控：jvm、gc、线程数
- 服务监控：rpc 和 http 接口的 qps、rt、错误码等

#### 业务监控

- 包含用户访问的 QPS，DAU，访问状态 （ http 状态码），业务接口 （登录，注册，聊天，送礼，留言，下单，支付，播放按钮点击率，搜索次数，好评差评数等等），产品转化率，充值额度，客诉等很宏观的概念

##### 基础业务监控

- 交易运营数据
- 业务监控自定义数据

##### 业务监控的发展

- 业务监控设置静态阔值无法满足要求
- 阈值应该配成多少，不同的业务甚至不同的时间段都需要不同的阔值
- 业务总是出现周期性的趋势，规则配置极易产生误报
- 特殊的业务场景例如活动引|起的冲高回落、大促的冲击都会引起大量误报
- 对大量维度的业务，比如要监控外部十方级别的商户、上百个不同类型的错误码该如何配置 
- 我们要根据业务特征和历史数据生成动态阀值，自动化报警，及时发现故障

**业界产品**

- 支付宝 lego
- 阿里妈妈 goldeneye

**一般架构图**

![](image/Pasted%20image%2020250105173345.png)

#### 网络监控

- IDC，对网络状态的监控（交换机、路由器、防火墙，vpn）对于一个互联网公司必不可少，但是有很多时候又被忽略
- 例如
	- 内网之间（物理内网，逻辑内网）
	- 外网
	- 丢包率
	- 网络重传
	- 延迟等等

#### 日志监控

- 日志监控比较重要，所以一般单独管理和分类，日志不仅限于服务系统日志，对于很多专业化的运维工程师来说，需要采集的包括系统日志，设备日志，用户行为日志等等，后续可加工处理，（splunk， ELK）

#### 常用监控图示

![](image/Pasted%20image%2020250105173653.png)

**链路监控**

![](image/Pasted%20image%2020250105173716.png)

**中间件监控**

![](image/Pasted%20image%2020250105173738.png)

## 当前排除故障的流程

目前公司线上业务，经常遇到以下几种问题

1. 由于环境的隔离，导致无法从本地开发环境访问线上环境，故而遇到问题，无法使用IDE远程调试应用程序
2. 为了线上业务的正常运作，所以不能在生产中调试，防止因调试导致所有线程不可用，从而影响线上业务
3. 不同环境，参数不同，重现问题难

一旦我们在生产中检测到问题，我们必须

1. 回滚到稳定版本
2. 在日志和代码中搜索错误和异常
3. 添加log日志，创建新的修补程序版本
4. 提交测试，等待测试和发布（有可能数天）
5. 部署预发，获取详细日志，验证问题
6. 发布新版本到线上

完成上述步骤，有的故障甚至持续数天，效率非常低下

故障诊断跟踪系统因此产生，其实纵观计算机科学的发展，也是需求促使着新技术不断被发明，又在一层一层的技术之上建立新的抽象

以京东的JEX平台为例

1. 自动捕获程序中发生的异常事件
2. 自动保存异常发生时的完整调用栈（callstack）
3. 自动保存异常发生时的变量值
4. 自动关联相关源代码和变量

异常退栈

![](image/Pasted%20image%2020250105174159.png)

![](image/Pasted%20image%2020250105174220.png)
# 线上故障排除

[生产故障定位和解决流程](#当前排除故障的流程) 上文提到过，在总结一下

1. 回滚到稳定版本
2. 在日志和代码中搜索错误和异常
3. 添加log日志，创建新的修补程序版本
4. 提交测试，等待测试和发布（数天）
5. 部署预发，获取详细日志，验证问题
6. 发布新版本到线上

另外，别忘了一个很重要的方法，**重启服务**

![](image/Pasted%20image%2020250105174530.png)
图来源于操作系统导论

## 工具篇

1. 一般情况下，需要了解业务场景，千万不要第一时间着急解决bug，应先评断是否可以回滚，影响面大小，是否为上层提供服务，是否有数据异常
2. 应熟悉项目依赖的监控，学会看监控
3. 应熟练开发环境的断点排查与诊断，熟悉git，maven，idea的使用，分析如何复现线上故障
4. 线上排查故障的工具链

### IDEA 断点

#### 行断点
- 在到达设置断点的代码行时暂停程序。这种类型的断点可以设置在任何可执行的代码行上

![](image/Pasted%20image%2020250105174807.png)

#### 字段断点

- 当指定的字段被读取或写入时暂停程序
- 这允许你对与特定实例变量的交互作出反应。
- 例如，如果在一个复杂的过程结束时，你的某个字段出现了明显的错误值，设置一个字段观察点可能有助于确定故障的来源

![](image/Pasted%20image%2020250105174846.png)

- 鼠标右键点击该断点图标 ，弹出该断点配置，会有 Field access 和 Field modification 选项，此选项是字段类型断点特有的，分别对应访问该字段或修改该字段触发断点，两项同时选中，则访问与修改该字段都会触发断点

![](image/Pasted%20image%2020250105174912.png)

#### 方法断点

在进入或退出指定的方法或其实现之一时暂停程序，允许你检查该方法的进入/退出条件

- 当断点加在class类名这一行，且该类中没有编写构造函数（只有默认无参构造函数），当调用默认无参构造函数时会触发此断点，程序挂起，故该断点虽然图标是行断点类型图标，但实际上属于方法类型断点

![](image/Pasted%20image%2020250106163914.png)

- 鼠标右键点击该断点图标 ，弹出该断点配置，会有Emulated、Method entry、Method exit选项，此选项是方法类型断点特有的。Emulated勾选中，会将方法断点优化成方法中第一条和最后一条语句的行断点，这样会优化调试的性能，因此在IDE中会默认选中，、
- 通过匹配符批量添加方法断点，在断点列表页

![](image/Pasted%20image%2020250106163957.png)


| **Class** | **Method** | **Result**                  |
| --------- | ---------- | --------------------------- |
| *         | print      | 匹配所有类的 print() 方法           |
| Printer   | *          | 匹配 Printer 类中的所有方法          |
| Printer   | set*       | 匹配 Printer 类中的所有方法名set开头的方法 |

#### 异常断点

- 异常断点分为两种，一种是Any Exception，任意Throwable异常被捕获或未被捕获就会触发断点，另一种是指定类型的异常及其该异常子类被捕获或未被捕获会触发断点
- 鼠标右键点击该断点图标 ，弹出该断点配置，会有Caught exception和Uncaught exception选项，此选项是字段类型断点特有的，Caught exception选项选中时，当指定的异常被捕获时，触发断点程序挂起，Uncaught exception选中时，当指定的异常未被捕获时，触发断点程序挂起

![](image/Pasted%20image%2020250106164239.png)
# 生产力建议

- 使用断点进行 "printf "调试使用非暂停的日志断点，而不是在代码中插入打印语句。这为处理调试日志信息提供了一种更灵活和集中的方式
	- 所有需要打印的地方，生产上禁止 System.out.print()

- 调试无响应的应用程序，如果你的应用程序挂起，暂停会话，让调试器获得关于其当前状态的信息。然后你可以检查程序的状态并找出问题的原因。
	- 项目启动卡死等处理

- 测试你的程序是否有并发性问题，发现多线程程序在并发方面是否健壮的一个好方法是使用断点，在碰到时只暂停一个线程。停止一个线程可能会揭示出应用程序设计中的问题，否则这些问题就不会显现出来

- 计算保留的大小
- 对于每个类的实例，你可以计算它的保留大小。保留大小是指对象本身和它所引用的所有对象以及没有被其他对象引用的对象所占据的内存量
- 这在估算重型单体或从磁盘上读取的数据（例如，复杂的JSON）的内存占用时，可能很有用
- 另外，在决定使用哪种数据结构时（例如，ArrayList与LinkedList），这也很有用。
- 在运行应用程序之前，确保在设置/首选项|构建、执行、部署|调试器中启用附加内存代理选项。在查看类的实例时，右键单击一个实例并单击计算保留大小。

![](image/Pasted%20image%2020250106164635.png)

![](image/Pasted%20image%2020250106164643.png)